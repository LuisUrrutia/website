---
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Navbar from "@/components/Navbar.astro";
import Container from "@/components/Container.astro";
import Card from "@/components/Card.astro";
import Pill from "@/components/Pill.astro";
import { ArticleJsonLd, BreadcrumbJsonLd } from "@/components/seo";
import {
	getAlternateLocale,
	getLocalizedPath,
	getSlugWithoutLocale,
	intlLocales,
	localeNames,
} from "@/i18n";
import { calculateReadingTime, formatReadingTime } from "@/lib/formatters";

interface Props {
	post: CollectionEntry<"blog">;
	translatedPost?: CollectionEntry<"blog">;
}

const { post, translatedPost } = Astro.props;
const { t, lang } = Astro.locals;

// Calculate reading time from raw content
const readingTime = calculateReadingTime(post.body ?? "");
const formattedReadingTime = formatReadingTime(readingTime, t);
const { Content } = await render(post);

const dateFormat: Intl.DateTimeFormatOptions = {
	day: "numeric",
	month: "long",
	year: "numeric",
};

const formattedDate = post.data.date.toLocaleDateString(
	intlLocales[lang],
	dateFormat,
);
const isoDate = post.data.date.toISOString().split("T")[0];

const formattedUpdatedDate = post.data.updatedDate
	? post.data.updatedDate.toLocaleDateString(intlLocales[lang], dateFormat)
	: null;

// Get the alternate language URL
const alternateLang = getAlternateLocale(lang);
const alternateUrl = translatedPost
	? getLocalizedPath(
			`/blog/${getSlugWithoutLocale(translatedPost.id)}`,
			alternateLang,
		)
	: null;

// Generate transition names from post slug
const slug = getSlugWithoutLocale(post.id);
const titleTransitionName = `post-title-${slug}`;
const pillTransitionName = `post-pill-${slug}`;

// Use Astro.site from config, fallback to request origin in dev
const siteUrl = (Astro.site ?? Astro.url.origin).toString().replace(/\/$/, "");
const postUrl = `${siteUrl}${getLocalizedPath(`/blog/${slug}`, lang)}`;

// Breadcrumb items for blog post page
const breadcrumbItems = [
	{ name: "Home", url: `${siteUrl}${getLocalizedPath("/", lang)}` },
	{ name: "Blog", url: `${siteUrl}${getLocalizedPath("/blog", lang)}` },
	{ name: post.data.title, url: postUrl },
];
---

<Layout
	title={post.data.title}
	description={post.data.description}
	ogType="article"
	article={{
		publishedTime: post.data.date.toISOString(),
		modifiedTime: post.data.updatedDate?.toISOString(),
		tags: post.data.tags,
	}}
>
	<BreadcrumbJsonLd slot="head" items={breadcrumbItems} />
	<ArticleJsonLd
		slot="head"
		title={post.data.title}
		description={post.data.description}
		url={postUrl}
		publishedTime={post.data.date.toISOString()}
		modifiedTime={post.data.updatedDate?.toISOString()}
		tags={post.data.tags}
	/>
	<Navbar />
	<Container as="main" class="flex flex-col gap-8" transition:animate="slide">
		<Card
			as="article"
			class="prose prose-neutral dark:prose-invert max-w-none"
			style="view-transition-name: post-card"
		>
			<header class="not-prose mb-8">
				<div class="flex flex-wrap items-center gap-3">
					<Pill style={`view-transition-name: ${pillTransitionName}`}
						>{post.data.category}</Pill
					>
					<span class="text-subtitle text-sm">
						<time datetime={isoDate}
							>{t("blog.publishedOn")} {formattedDate}</time
						>
					</span>
					<span class="text-subtitle text-sm"
						>&middot; {formattedReadingTime}</span
					>
					{
						formattedUpdatedDate && (
							<span class="text-subtitle text-sm">
								&middot; {t("blog.updatedOn")} {formattedUpdatedDate}
							</span>
						)
					}
				</div>

				<h1
					class="text-title mt-4 text-3xl font-bold md:text-4xl"
					style={`view-transition-name: ${titleTransitionName}`}
				>
					{post.data.title}
				</h1>

				<p class="text-subtitle mt-4 text-lg">
					{post.data.description}
				</p>

				{
					alternateUrl && (
						<p class="text-subtitle mt-4 text-sm">
							{t("blog.alsoAvailable")}{" "}
							<a href={alternateUrl} class="text-accent hover:underline">
								{localeNames[alternateLang]}
							</a>
						</p>
					)
				}
			</header>

			<div class="blog-content">
				<Content />
			</div>
		</Card>
	</Container>
</Layout>

<style is:global>
	.blog-content h2 {
		color: var(--color-title);
		margin-top: 2rem;
		margin-bottom: 1rem;
		font-size: 1.5rem;
		line-height: 2rem;
		font-weight: 600;
	}

	.blog-content h3 {
		color: var(--color-title);
		margin-top: 1.5rem;
		margin-bottom: 0.75rem;
		font-size: 1.25rem;
		line-height: 1.75rem;
		font-weight: 600;
	}

	.blog-content p {
		color: var(--color-foreground);
		margin-bottom: 1rem;
		line-height: 1.625;
	}

	.blog-content ul,
	.blog-content ol {
		color: var(--color-foreground);
		margin-bottom: 1rem;
		margin-left: 1.5rem;
		list-style-position: outside;
	}

	.blog-content ul {
		list-style-type: disc;
	}

	.blog-content ol {
		list-style-type: decimal;
	}

	.blog-content li {
		margin-bottom: 0.5rem;
	}

	.blog-content pre {
		background-color: var(--color-card);
		margin-top: 1.5rem;
		margin-bottom: 1.5rem;
		overflow-x: auto;
		border-radius: 0.75rem;
		padding: 1rem;
	}

	.blog-content code {
		font-size: 0.875rem;
		line-height: 1.25rem;
	}

	.blog-content :not(pre) > code {
		background-color: var(--color-card);
		border-radius: 0.25rem;
		padding: 0.125rem 0.375rem;
	}

	.blog-content strong {
		color: var(--color-title);
		font-weight: 600;
	}

	.blog-content a {
		color: var(--color-accent);
	}

	.blog-content a:hover {
		text-decoration: underline;
	}

	.blog-content blockquote {
		border-left: 4px solid var(--color-accent);
		color: var(--color-subtitle);
		margin-top: 1.5rem;
		margin-bottom: 1.5rem;
		padding-left: 1rem;
		font-style: italic;
	}
</style>
