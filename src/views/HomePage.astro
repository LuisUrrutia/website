---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Navbar from "@/components/Navbar.astro";
import { HomePageJsonLd } from "@/components/seo";
import { socials } from "@/data/socials";
import { technologies } from "@/data/technologies";
import { testimonials } from "@/data/testimonials";
import Container from "@/components/Container.astro";
import HeroSection from "@/sections/HeroSection.astro";
import StackSection from "@/sections/StackSection.astro";
import LatestPostsSection from "@/sections/LatestPostsSection.astro";
import TestimonialsSection from "@/sections/TestimonialsSection.astro";
import ContactSection from "@/sections/ContactSection.astro";
import { getLocalizedPath, getSlugWithoutLocale } from "@/i18n";

const { t, lang } = Astro.locals;

// Use Astro.site from config, fallback to request origin in dev
const siteUrl = (Astro.site ?? Astro.url.origin).toString().replace(/\/$/, "");
const description = t("meta.description");

// Get latest posts for current locale
const allPosts = await getCollection("blog", ({ data, id }) => {
	return id.startsWith(`${lang}/`) && data.draft !== true;
});

const posts = allPosts
	.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
	.slice(0, 3)
	.map((post) => {
		const slug = getSlugWithoutLocale(post.id);
		return {
			title: post.data.title,
			category: post.data.category,
			date: post.data.date,
			href: getLocalizedPath(`/blog/${slug}`, lang),
			slug,
		};
	});
---

<Layout ogImageAlt={t("meta.ogImageAlt")}>
	<HomePageJsonLd
		slot="head"
		siteUrl={siteUrl}
		jobTitle={t("meta.jobTitle")}
		description={description}
	/>
	<Navbar />
	<Container as="main" class="flex flex-col gap-8" transition:animate="fade">
		<HeroSection socials={socials} />
		<StackSection technologies={technologies} />
		{
			posts.length > 0 && (
				<LatestPostsSection
					posts={posts}
					viewMoreHref={getLocalizedPath("/blog", lang)}
				/>
			)
		}
		<TestimonialsSection testimonials={testimonials} />
		<ContactSection contactHref="mailto:hello@urrutia.me" socials={socials} />
	</Container>
</Layout>
