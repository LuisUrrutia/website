---
import Card from "@/components/Card.astro";
import BlogEntry from "@/components/BlogEntry.astro";
import ViewMoreButton from "@/components/ViewMoreButton.astro";

interface Post {
	title: string;
	category: string;
	date: Date;
	href: string;
}

interface Props {
	posts: Post[];
	initialVisible?: number;
	title?: string;
	id?: string;
}

const {
	posts,
	initialVisible = 3,
	title = "Latest posts",
	id = "latest-posts",
} = Astro.props;

const hasMorePosts = posts.length > initialVisible;
const listId = `${id}-list`;
---

<Card
	id={id}
	class="posts-section flex flex-col gap-6"
	data-initial-visible={initialVisible}
>
	<h2 class="text-title text-2xl font-semibold">{title}</h2>

	{
		posts.length === 0 ? (
			<p class="text-secondary">No posts available.</p>
		) : (
			<ul
				id={listId}
				class="m-0 flex list-none flex-col p-0"
				aria-live="polite"
			>
				{posts.map((post, index) => (
					<li class:list={["posts-item", { hidden: index >= initialVisible }]}>
						<BlogEntry
							title={post.title}
							category={post.category}
							date={post.date}
							href={post.href}
						/>
					</li>
				))}
			</ul>
		)
	}

	{
		hasMorePosts && (
			<ViewMoreButton class="posts-view-more" controlsId={listId} />
		)
	}
</Card>

<script>
	function initPostsSections(): void {
		const sections = document.querySelectorAll<HTMLElement>(".posts-section");

		sections.forEach((section) => {
			if (section.dataset.init) return;
			section.dataset.init = "true";

			const initialVisible = parseInt(
				section.dataset.initialVisible ?? "3",
				10,
			);
			const items = section.querySelectorAll<HTMLLIElement>(".posts-item");
			const viewMoreBtn =
				section.querySelector<HTMLButtonElement>(".posts-view-more");

			if (!viewMoreBtn || items.length <= initialVisible) return;

			viewMoreBtn.addEventListener("view-more-toggle", ((
				e: CustomEvent<{ expanded: boolean }>,
			) => {
				items.forEach((item, index) => {
					if (index >= initialVisible) {
						item.classList.toggle("hidden", !e.detail.expanded);
					}
				});
			}) as EventListener);
		});
	}

	initPostsSections();
	document.addEventListener("astro:after-swap", initPostsSections);
</script>
