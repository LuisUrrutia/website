---
import Card from "@/components/Card.astro";
import BlogEntry from "@/components/BlogEntry.astro";
import ViewMoreButton from "@/components/ViewMoreButton.astro";

interface Post {
	title: string;
	category: string;
	date: Date;
	href: string;
}

interface Props {
	posts: Post[];
	initialVisible?: number;
	title?: string;
	id?: string;
}

const {
	posts,
	initialVisible = 3,
	title = "Latest posts",
	id = "latest-posts",
} = Astro.props;

const hasMorePosts = posts.length > initialVisible;
const listId = `${id}-list`;
---

<Card
	id={id}
	class="flex flex-col gap-6"
	data-posts-section
	data-initial-visible={initialVisible}
>
	<h2 class="text-title text-2xl font-semibold">{title}</h2>

	{
		posts.length === 0 ? (
			<p class="text-secondary">No posts available.</p>
		) : (
			<ul
				id={listId}
				class="m-0 flex list-none flex-col p-0"
				aria-live="polite"
			>
				{posts.map((post, index) => (
					<li class:list={["posts-item", { hidden: index >= initialVisible }]}>
						<BlogEntry
							title={post.title}
							category={post.category}
							date={post.date}
							href={post.href}
						/>
					</li>
				))}
			</ul>
		)
	}

	{
		hasMorePosts && (
			<ViewMoreButton class="posts-view-more" controlsId={listId} />
		)
	}
</Card>

<script>
	function initPostsSection(): void {
		const sections = document.querySelectorAll<HTMLElement>(
			"[data-posts-section]",
		);

		sections.forEach((section) => {
			if (section.dataset.initialized === "true") return;
			section.dataset.initialized = "true";

			const initialVisible = parseInt(
				section.dataset.initialVisible ?? "3",
				10,
			);
			const items = section.querySelectorAll<HTMLLIElement>(".posts-item");
			const viewMoreBtn =
				section.querySelector<HTMLButtonElement>(".posts-view-more");
			const viewMoreText = viewMoreBtn?.querySelector<HTMLSpanElement>(
				"[data-view-more-text]",
			);

			if (!viewMoreBtn || items.length <= initialVisible) return;

			let isExpanded = false;

			const updateVisibility = (): void => {
				items.forEach((item, index) => {
					if (index >= initialVisible) {
						item.classList.toggle("hidden", !isExpanded);
					}
				});

				viewMoreBtn.setAttribute("aria-expanded", String(isExpanded));

				if (viewMoreText) {
					viewMoreText.textContent = isExpanded
						? (viewMoreBtn.dataset.expandedText ?? "Read Less")
						: (viewMoreBtn.dataset.collapsedText ?? "Read More");
				}
			};

			viewMoreBtn.addEventListener("click", () => {
				isExpanded = !isExpanded;
				updateVisibility();
			});
		});
	}

	initPostsSection();
	document.addEventListener("astro:after-swap", initPostsSection);
</script>
