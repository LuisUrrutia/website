---
import Layout from "@/layouts/Layout.astro";
import {
	locales,
	defaultLocale,
	getLocalizedPath,
	useTranslations,
} from "@/i18n";

/**
 * 404 page with no-flash locale detection.
 *
 * Renders content for ALL locales (hidden by default), then a blocking
 * script immediately shows only the correct locale based on URL path.
 * This prevents any flash of wrong-language content.
 */

// Pre-generate translations for all locales
const localeData = locales.map((locale) => {
	const t = useTranslations(locale);
	return {
		locale,
		heading: t("404.heading"),
		description: t("404.description"),
		backHome: t("404.backHome"),
		homeHref: getLocalizedPath("/", locale),
	};
});

// For meta tags, use default locale
const t = useTranslations(defaultLocale);
---

<Layout
	title={t("404.title")}
	description={t("404.description")}
	noindex
	skipLocaleRedirect
>
	{/* Blocking script to detect locale BEFORE content renders */}
	<script
		is:inline
		data-locales={JSON.stringify(locales)}
		data-default-locale={defaultLocale}
	>
		(function () {
			const script = document.currentScript;
			const locales = JSON.parse(script.dataset.locales);
			const defaultLocale = script.dataset.defaultLocale;
			const pathname = window.location.pathname;

			let locale = defaultLocale;
			for (const l of locales) {
				if (pathname.startsWith("/" + l + "/") || pathname === "/" + l) {
					locale = l;
					break;
				}
			}

			document.documentElement.lang = locale;
			document.documentElement.dataset.locale404 = locale;
		})();
	</script>

	<style is:inline>
		/* Hide all locale content by default */
		[data-locale-content] {
			display: none;
		}
		/* Show only the matching locale */
		html[data-locale-404="en"] [data-locale-content="en"],
		html[data-locale-404="es"] [data-locale-content="es"] {
			display: block;
		}
		/* For the link inside, use inline display */
		html[data-locale-404="en"] a[data-locale-content="en"],
		html[data-locale-404="es"] a[data-locale-content="es"] {
			display: inline-flex;
		}
	</style>

	<main
		class="mx-auto flex min-h-[80vh] max-w-xl flex-col items-center justify-center px-4 text-center"
	>
		<h1 class="text-title mb-4 text-6xl font-bold">404</h1>

		{
			localeData.map(({ locale, heading, description, backHome, homeHref }) => (
				<>
					<h2
						data-locale-content={locale}
						class="text-title mb-4 text-2xl font-semibold"
					>
						{heading}
					</h2>
					<p data-locale-content={locale} class="text-subtitle mb-8">
						{description}
					</p>
					<a
						data-locale-content={locale}
						href={homeHref}
						class="bg-button text-button-foreground hover:bg-button-hover rounded-lg px-6 py-3 font-medium transition-colors"
					>
						{backHome}
					</a>
				</>
			))
		}
	</main>
</Layout>
