---
/**
 * BackToTop - A floating button that scrolls the page to the top.
 *
 * Shows after scrolling down and smoothly scrolls to top when clicked.
 */
import IconArrowUp from "@/assets/icons/arrow-up.svg";

const { t } = Astro.locals;
---

<button
	id="back-to-top"
	type="button"
	aria-label={t("a11y.backToTop")}
	class="bg-card shadow-soft focus-visible:ring-accent fixed right-6 bottom-6 z-40 flex size-10 translate-y-16 items-center justify-center rounded-full opacity-0 transition-all duration-300 hover:scale-110 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 motion-reduce:transition-none motion-reduce:hover:scale-100"
	aria-hidden="true"
>
	<IconArrowUp class="size-5" aria-hidden="true" />
</button>

<script>
	let cleanupBackToTop: (() => void) | null = null;

	function initBackToTop(): void {
		// Clean up previous listeners before adding new ones
		cleanupBackToTop?.();

		const button = document.getElementById("back-to-top");
		if (!button) return;

		let isVisible = false;
		const controller = new AbortController();

		function toggleVisibility(): void {
			const shouldShow = window.scrollY > 400;

			if (shouldShow !== isVisible) {
				isVisible = shouldShow;
				button!.style.opacity = shouldShow ? "1" : "0";
				button!.style.transform = shouldShow
					? "translateY(0)"
					: "translateY(4rem)";
				button!.style.pointerEvents = shouldShow ? "auto" : "none";
				button!.setAttribute("aria-hidden", String(!shouldShow));

				// Blur button when hiding to prevent focus issues
				if (!shouldShow && document.activeElement === button) {
					button!.blur();
				}
			}
		}

		function scrollToTop(): void {
			const prefersReducedMotion = window.matchMedia(
				"(prefers-reduced-motion: reduce)",
			).matches;
			window.scrollTo({
				top: 0,
				behavior: prefersReducedMotion ? "instant" : "smooth",
			});
		}

		// Initial check
		toggleVisibility();

		// Listen for scroll and click with AbortController for cleanup
		window.addEventListener("scroll", toggleVisibility, {
			passive: true,
			signal: controller.signal,
		});
		button.addEventListener("click", scrollToTop, {
			signal: controller.signal,
		});

		// Store cleanup function
		cleanupBackToTop = () => controller.abort();
	}

	initBackToTop();
	document.addEventListener("astro:after-swap", initBackToTop);
</script>
