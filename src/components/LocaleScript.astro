---
/**
 * LocaleScript - Inline blocking script for locale detection and redirect.
 *
 * Handles:
 * - Browser language detection for first-time visitors only
 * - Automatic redirect to preferred locale on first visit
 *
 * After the first visit, users can navigate freely between locales.
 * Must be placed in <head> before any rendering.
 */
import { locales, defaultLocale } from "@/i18n/locales";

interface Props {
	currentLocale: string;
}

const { currentLocale } = Astro.props;
const localesJson = JSON.stringify(locales);
---

<script
	is:inline
	data-current-locale={currentLocale}
	data-default-locale={defaultLocale}
	data-locales={localesJson}
>
	(function () {
		const script = document.currentScript;
		const currentLocale = script.dataset.currentLocale;
		const defaultLocale = script.dataset.defaultLocale;
		const locales = JSON.parse(script.dataset.locales);

		const HAS_VISITED_KEY = "has-visited";
		const COOKIE_NAME = "has-visited";

		function getCookie(name) {
			const match = document.cookie.match(
				new RegExp("(^| )" + name + "=([^;]+)"),
			);
			return match ? match[2] : null;
		}

		function setCookie(name, value, maxAge) {
			document.cookie =
				name + "=" + value + ";path=/;max-age=" + maxAge + ";SameSite=Lax";
		}

		function hasVisited() {
			try {
				return localStorage.getItem(HAS_VISITED_KEY) === "true";
			} catch {
				return getCookie(COOKIE_NAME) === "true";
			}
		}

		function setHasVisited() {
			const maxAge = 60 * 60 * 24 * 365; // 1 year
			try {
				localStorage.setItem(HAS_VISITED_KEY, "true");
			} catch {
				// localStorage not available
			}
			setCookie(COOKIE_NAME, "true", maxAge);
		}

		function getBrowserLocale() {
			const browserLang = navigator.language || navigator.userLanguage;
			if (!browserLang) return null;

			// Check exact match first (e.g., "es-CL" -> "es")
			const langCode = browserLang.split("-")[0].toLowerCase();
			return locales.includes(langCode) ? langCode : null;
		}

		function getLocalizedPath(path, locale) {
			if (locale === defaultLocale) return path;
			return "/" + locale + path;
		}

		function getPathWithoutLocale(pathname) {
			for (const locale of locales) {
				if (pathname.startsWith("/" + locale + "/")) {
					return pathname.slice(locale.length + 1);
				}
				if (pathname === "/" + locale) {
					return "/";
				}
			}
			return pathname;
		}

		// Only redirect on first visit
		if (hasVisited()) {
			return;
		}

		// Mark as visited
		setHasVisited();

		// Detect browser language and redirect if needed
		const browserLocale = getBrowserLocale();
		if (browserLocale && browserLocale !== currentLocale) {
			const pathWithoutLocale = getPathWithoutLocale(window.location.pathname);
			const newPath = getLocalizedPath(pathWithoutLocale, browserLocale);
			window.location.replace(newPath + window.location.search);
		}
	})();
</script>
