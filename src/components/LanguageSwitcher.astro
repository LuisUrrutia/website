---
/**
 * LanguageSwitcher - A compact select-based language switcher.
 *
 * Automatically detects current locale from Astro.locals and provides
 * a dropdown to switch between available languages.
 *
 * Uses hreflang link tags from the document head as the source of truth
 * for alternate language URLs. This ensures consistency with SEO meta tags
 * and works correctly for pages with different slugs per locale (e.g., blog posts).
 *
 * @example
 * ```astro
 * <LanguageSwitcher />
 * ```
 */
import { locales, localeNames } from "@/i18n";

interface Props {
	class?: string;
}

const { class: className } = Astro.props;
const { lang, t } = Astro.locals;
---

<div
	class:list={["language-switcher relative", className]}
	data-current-lang={lang}
>
	<label class="sr-only" for="language-select"
		>{t("a11y.languageSwitcher")}</label
	>
	<select
		id="language-select"
		class="bg-card text-foreground hover:bg-card/80 focus:ring-accent cursor-pointer appearance-none rounded px-2 py-1 pr-7 text-sm transition-colors focus:ring-2 focus:outline-none"
	>
		{
			locales.map((locale) => (
				<option value={locale} selected={locale === lang}>
					{localeNames[locale]}
				</option>
			))
		}
	</select>
	<svg
		class="text-subtitle pointer-events-none absolute top-1/2 right-1.5 size-4 -translate-y-1/2"
		xmlns="http://www.w3.org/2000/svg"
		viewBox="0 0 20 20"
		fill="currentColor"
		aria-hidden="true"
	>
		<path
			fill-rule="evenodd"
			d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z"
			clip-rule="evenodd"></path>
	</svg>
</div>

<script>
	/**
	 * Gets alternate language URLs from hreflang link tags in the document head.
	 * These are the canonical source of truth for language-specific URLs.
	 */
	function getHreflangUrls(): Record<string, string> {
		const urls: Record<string, string> = {};
		document
			.querySelectorAll<HTMLLinkElement>('link[rel="alternate"][hreflang]')
			.forEach((link) => {
				const hreflang = link.getAttribute("hreflang");
				// Skip x-default as it's not a specific locale
				if (hreflang && hreflang !== "x-default") {
					urls[hreflang] = link.href;
				}
			});
		return urls;
	}

	function initLanguageSwitcher(): void {
		document
			.querySelectorAll<HTMLSelectElement>("#language-select")
			.forEach((select) => {
				if (select.dataset.init) return;
				select.dataset.init = "true";

				select.addEventListener("change", () => {
					const locale = select.value;
					const urls = getHreflangUrls();
					const url = urls[locale];
					if (url) {
						window.location.href = url;
					}
				});
			});
	}

	initLanguageSwitcher();
	document.addEventListener("astro:after-swap", initLanguageSwitcher);
</script>
