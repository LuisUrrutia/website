---
/**
 * HomePageJsonLd - Combined JSON-LD schema for the homepage.
 *
 * Uses @graph to combine multiple schema types:
 * - WebSite: Site-level information
 * - ProfilePage: Google's ProfilePage schema for personal sites
 * - Person: Detailed person information
 *
 * @see https://developers.google.com/search/docs/appearance/structured-data/profile-page
 */
import { execSync } from "node:child_process";
import { siteOwner, siteName, buildPersonEntity } from "@/data/seo";
import { toISOWithTimezone } from "@/lib/formatters";

/** Get the last git commit date as a stable dateModified value */
function getLastCommitDate(): Date {
	try {
		const timestamp = execSync("git log -1 --format=%cI", {
			encoding: "utf-8",
		}).trim();
		return new Date(timestamp);
	} catch {
		return new Date();
	}
}

interface Props {
	siteUrl: string;
	jobTitle: string;
	description: string;
}

const { siteUrl, jobTitle, description } = Astro.props;

// Person entity (referenced by ProfilePage and WebSite)
const personEntity = buildPersonEntity(siteUrl, {
	jobTitle,
	description,
	withId: true,
});

// WebSite entity
const websiteEntity = {
	"@type": "WebSite",
	"@id": `${siteUrl}/#website`,
	name: siteName,
	url: siteUrl,
	description,
	inLanguage: [...siteOwner.languages],
	author: {
		"@id": `${siteUrl}/#person`,
	},
};

// ProfilePage entity (Google's schema for personal profile pages)
const profilePageEntity = {
	"@type": "ProfilePage",
	"@id": `${siteUrl}/#profilepage`,
	url: siteUrl,
	name: `${siteOwner.name} - ${jobTitle}`,
	description,
	isPartOf: {
		"@id": `${siteUrl}/#website`,
	},
	mainEntity: {
		"@id": `${siteUrl}/#person`,
	},
	dateCreated: toISOWithTimezone(new Date("2024-01-01T00:00:00")),
	dateModified: toISOWithTimezone(getLastCommitDate()),
};

const jsonLd = {
	"@context": "https://schema.org",
	"@graph": [websiteEntity, profilePageEntity, personEntity],
};
---

<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
