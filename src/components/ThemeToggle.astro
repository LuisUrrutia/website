---
import type { HTMLAttributes } from "astro/types";
import IconSun from "@/assets/icons/sun.svg";
import IconMoon from "@/assets/icons/moon.svg";
import IconSunMoon from "@/assets/icons/sun-moon.svg";

interface Props extends HTMLAttributes<"button"> {
	labels?: {
		auto?: string;
		light?: string;
		dark?: string;
	};
}

const { t } = Astro.locals;

const {
	class: className,
	labels = {
		auto: t("theme.auto"),
		light: t("theme.light"),
		dark: t("theme.dark"),
	},
	...attrs
} = Astro.props;
---

<button
	type="button"
	class:list={[
		"theme-toggle hover:text-subtitle flex cursor-pointer items-center justify-center transition-colors",
		className,
	]}
	aria-label={labels.auto}
	data-theme-toggle
	data-label-auto={labels.auto}
	data-label-light={labels.light}
	data-label-dark={labels.dark}
	{...attrs}
>
	<IconSun
		class="theme-icon theme-icon-light size-6 sm:size-4"
		aria-hidden="true"
	/>
	<IconMoon
		class="theme-icon theme-icon-dark size-6 sm:size-4"
		aria-hidden="true"
	/>
	<IconSunMoon
		class="theme-icon theme-icon-auto size-6 sm:size-4"
		aria-hidden="true"
	/>
</button>

<style>
	.theme-icon {
		display: none;
	}

	/* Show icon based on button's data-mode (set by JS after interaction) */
	:where(.theme-toggle[data-mode="light"]) .theme-icon-light,
	:where(.theme-toggle[data-mode="dark"]) .theme-icon-dark,
	:where(.theme-toggle[data-mode="auto"]) .theme-icon-auto {
		display: block;
	}

	/* Initial state: show icon based on root's data-theme-mode (set by blocking script) */
	:global(:where([data-theme-mode="light"]))
		.theme-toggle:not([data-mode])
		.theme-icon-light,
	:global(:where([data-theme-mode="dark"]))
		.theme-toggle:not([data-mode])
		.theme-icon-dark,
	:global(:where([data-theme-mode="auto"]))
		.theme-toggle:not([data-mode])
		.theme-icon-auto {
		display: block;
	}
</style>

<script>
	import {
		getStoredMode,
		cycleMode,
		initThemeListener,
		type ThemeMode,
	} from "@/lib/theme";

	// Cache buttons - refreshed on navigation
	let cachedButtons: HTMLButtonElement[] = [];

	function refreshButtonCache(): void {
		cachedButtons = Array.from(
			document.querySelectorAll<HTMLButtonElement>("[data-theme-toggle]"),
		);
	}

	function updateButton(btn: HTMLButtonElement, mode: ThemeMode): void {
		btn.dataset.mode = mode;
		// Read label from data attribute (supports i18n)
		const label =
			btn.dataset[`label${mode.charAt(0).toUpperCase()}${mode.slice(1)}`];
		if (label) btn.ariaLabel = label;
	}

	function updateAllButtons(mode: ThemeMode): void {
		for (const btn of cachedButtons) {
			updateButton(btn, mode);
		}
	}

	function initThemeToggle(): void {
		refreshButtonCache();
		updateAllButtons(getStoredMode());

		// Event delegation on document - handles all current and future buttons
		document.addEventListener("click", (e) => {
			const btn = (e.target as HTMLElement).closest<HTMLButtonElement>(
				"[data-theme-toggle]",
			);
			if (!btn) return;

			const currentMode = (btn.dataset.mode as ThemeMode) || "auto";
			const newMode = cycleMode(currentMode);
			updateAllButtons(newMode);
		});

		initThemeListener();
	}

	initThemeToggle();
	document.addEventListener("astro:after-swap", () => {
		refreshButtonCache();
		updateAllButtons(getStoredMode());
	});
</script>
