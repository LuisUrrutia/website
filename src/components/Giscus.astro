---
/**
 * Giscus - GitHub Discussions-based comments component.
 *
 * Features:
 * - Syncs theme with site's light/dark mode
 * - Supports i18n (en/es)
 * - Lazy loads for performance
 */
import type { Locale } from "@/i18n";

interface Props {
	/** Current page locale */
	lang?: Locale;
}

const { lang = "en" } = Astro.props;
---

<div class="giscus-wrapper border-border mt-8 border-t pt-8">
	<div class="giscus"></div>
</div>

<script is:inline data-lang={lang}>
	// Store observers for cleanup
	let giscusIntersectionObserver = null;
	let giscusThemeObserver = null;

	function loadGiscus() {
		const wrapper = document.querySelector(".giscus-wrapper");
		if (!wrapper || wrapper.dataset.loaded) return;

		const lang = document.currentScript?.dataset.lang || "en";
		const theme =
			document.documentElement.dataset.theme === "dark"
				? "transparent_dark"
				: "light";

		const script = document.createElement("script");
		script.src = "https://giscus.app/client.js";
		script.dataset.repo = "LuisUrrutia/website";
		script.dataset.repoId = "R_kgDOQnDWeA";
		script.dataset.category = "General";
		script.dataset.categoryId = "DIC_kwDOQnDWeM4C1x7v";
		script.dataset.mapping = "og:title";
		script.dataset.strict = "0";
		script.dataset.reactionsEnabled = "1";
		script.dataset.emitMetadata = "0";
		script.dataset.inputPosition = "top";
		script.dataset.theme = theme;
		script.dataset.lang = lang;
		script.dataset.loading = "lazy";
		script.crossOrigin = "anonymous";
		script.async = true;

		wrapper.appendChild(script);
		wrapper.dataset.loaded = "true";
	}

	function updateGiscusTheme() {
		const iframe = document.querySelector("iframe.giscus-frame");
		if (!iframe) return;

		const theme =
			document.documentElement.dataset.theme === "dark"
				? "transparent_dark"
				: "light";

		iframe.contentWindow?.postMessage(
			{ giscus: { setConfig: { theme } } },
			"https://giscus.app",
		);
	}

	function cleanupGiscus() {
		giscusIntersectionObserver?.disconnect();
		giscusIntersectionObserver = null;
		// Note: Theme observer persists across navigations since theme state is global
	}

	function initGiscus() {
		// Clean up previous intersection observer
		cleanupGiscus();

		const wrapper = document.querySelector(".giscus-wrapper");
		if (!wrapper) return;

		// Use Intersection Observer to lazy load when visible
		giscusIntersectionObserver = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						loadGiscus();
						giscusIntersectionObserver?.disconnect();
					}
				});
			},
			{ rootMargin: "400px" },
		);

		giscusIntersectionObserver.observe(wrapper);
	}

	// Initialize on page load
	initGiscus();

	// Reinitialize after Astro page transitions
	document.addEventListener("astro:after-swap", initGiscus);

	// Listen for theme changes (only create once, persists across navigations)
	if (!giscusThemeObserver) {
		giscusThemeObserver = new MutationObserver((mutations) => {
			for (const mutation of mutations) {
				if (mutation.attributeName === "data-theme") {
					updateGiscusTheme();
				}
			}
		});

		giscusThemeObserver.observe(document.documentElement, {
			attributes: true,
			attributeFilter: ["data-theme"],
		});
	}
</script>
